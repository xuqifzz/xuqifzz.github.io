<!DOCTYPE html>
<html lang=>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="专注于应用程序框架开发">
  <meta name="keywords" content="">
  
    <link rel="icon" href="/favicon.ico">
  
    
  <title>使用字面值初始化Map | 徐琦的博客</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class="logo" href="/">
      <span>徐琦的博客</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id="post">
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>使用字面值初始化Map</h1>
          <div class="post-meta">
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019/01/23</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>



            
            
              | 
                  <i class="fa fa-tag" aria-hidden="true"></i>
                
               
  <a href="/tags/#语言特性" class="tag">语言特性</a>


            
          </div>
          <p>在Java中使用字面值初始化一个Map很困难, 正如Java的一贯作风, 代码比较恶心, 比如<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">myMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">myMap.put(<span class="string">"id"</span>, <span class="number">5</span>);</span><br><span class="line">myMap.put(<span class="string">"name"</span>, <span class="string">"xuqi"</span>);</span><br><span class="line">myMap.put(<span class="string">"age"</span>, <span class="number">18</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="其他语言的做法"><a href="#其他语言的做法" class="headerlink" title="其他语言的做法"></a>其他语言的做法</h3><ul>
<li><p>Javascript</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> myMap=&#123;<span class="attr">id</span>:<span class="number">5</span>, <span class="attr">name</span>: <span class="string">"xuqi"</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Python</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">myMap = &#123;<span class="string">'id'</span>: <span class="number">5</span>, name: <span class="string">'xuqi'</span>, <span class="string">'age'</span>: <span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>C#</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> myMap = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Object&gt; &#123;&#123;<span class="string">"id"</span>, <span class="number">5</span>&#125;, &#123;<span class="string">"name"</span>, <span class="string">"xuqi"</span>&#125;, &#123;<span class="string">"age"</span>, <span class="number">18</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>C++</p>
</li>
</ul>
<p>就连C++ 都…<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int</span>, <span class="built_in">string</span>&gt; int_to_string = &#123;&#123;<span class="number">1</span>, <span class="string">"java"</span>&#125;, &#123;<span class="number">2</span>, <span class="string">"is"</span>&#125;, &#123;<span class="number">3</span>, <span class="string">"pretty"</span>&#125;&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="Java中的一些解决办法"><a href="#Java中的一些解决办法" class="headerlink" title="Java中的一些解决办法"></a>Java中的一些解决办法</h3><h4 id="双括号初始化法"><a href="#双括号初始化法" class="headerlink" title="双括号初始化法"></a>双括号初始化法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这个方法多了一些多余的put很令人不爽</span></span><br><span class="line">Map&lt;String , Object&gt; map = <span class="keyword">new</span> HashMap&lt;String , Object&gt;()&#123;&#123;</span><br><span class="line">    put(<span class="string">"id"</span>, <span class="number">5</span>);</span><br><span class="line">    put(<span class="string">"name"</span>, <span class="string">"xuqi"</span>);</span><br><span class="line">    put(<span class="string">"age"</span>, <span class="number">18</span>);</span><br><span class="line">&#125;&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="二维数组封装法"><a href="#二维数组封装法" class="headerlink" title="二维数组封装法"></a>二维数组封装法</h4><p>定义如下函数:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Map&lt;String,String&gt; <span class="title">createStringMap</span><span class="params">(String[][] entries)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Stream.of(entries).collect(Collectors.toMap(data -&gt; data[<span class="number">0</span>], data -&gt; data[<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Map&lt;String,Integer&gt; <span class="title">createIntegerMap</span><span class="params">(Object[][] entries)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Stream.of(entries).collect(Collectors.toMap(data -&gt; (String) data[<span class="number">0</span>], data -&gt; (Integer) data[<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>则可以用如下方式创建Map<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建值为String的Map</span></span><br><span class="line">Map&lt;String,String&gt; stringMap = </span><br><span class="line">    createStringMap(<span class="keyword">new</span> String[][] &#123;&#123; <span class="string">"key1"</span>, <span class="string">"value1"</span> &#125;,&#123; <span class="string">"key2"</span>, <span class="string">"value2"</span> &#125;,&#123; <span class="string">"key3"</span>, <span class="string">"value3"</span> &#125;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建值为Integer的Map</span></span><br><span class="line">Map&lt;String,Integer&gt; intMap = </span><br><span class="line">    createIntegerMap(<span class="keyword">new</span> Object[][] &#123;&#123; <span class="string">"key1"</span>, <span class="number">1</span> &#125;,&#123; <span class="string">"key2"</span>, <span class="number">2</span> &#125;,&#123; <span class="string">"key3"</span>, <span class="number">3</span> &#125;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>遗憾的是, 因为Java<em>强大的类型擦除特性</em>, 通过这个思路暂时无法写出下面的方法, 除非再加个恶心的<code>Class&lt;T&gt;</code>参数<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//该方法因为类型擦除无法实现</span></span><br><span class="line"><span class="keyword">static</span>  &lt;T&gt; <span class="function">Map&lt;String,T&gt; <span class="title">createMap</span><span class="params">(Object[][] entries)</span></span></span><br></pre></td></tr></table></figure></p>
<p>另外这个方式也没有编译时检查功能, 不太安全。</p>
<h4 id="参数列表封装法"><a href="#参数列表封装法" class="headerlink" title="参数列表封装法"></a>参数列表封装法</h4><p>有很多类库都是这个办法,比如Java 9的<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, String&gt; unmodifiableMap = Map.of(<span class="string">"key1"</span>, <span class="string">"value1"</span>, <span class="string">"key2"</span>, <span class="string">"value2"</span>);</span><br></pre></td></tr></table></figure></p>
<p>自己实现的话,大概可以这样<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;A&gt; <span class="function">Map&lt;String, A&gt; <span class="title">asMap</span><span class="params">(Object... keysAndValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LinkedHashMap&lt;String, A&gt;() &#123;&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; keysAndValues.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            put(keysAndValues[i].toString(), (A) keysAndValues[++i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以这样调用<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, String&gt; one = asMap(<span class="string">"1stKey"</span>, <span class="string">"1stVal"</span>, <span class="string">"2ndKey"</span>, <span class="string">"2ndVal"</span>);</span><br><span class="line">Map&lt;String, Object&gt; two = asMap(<span class="string">"1stKey"</span>, Boolean.TRUE, <span class="string">"2ndKey"</span>, <span class="keyword">new</span> Integer(<span class="number">2</span>));</span><br></pre></td></tr></table></figure></p>
<p>上面的asMap没有编译期类型安全检查, 而Java9的版本似乎是安全的,但好像参数数量有限制,而且限制的数量还很少(这点我没去确认)</p>
<p>另外这个方式语义也不太好, Map应该是一对对的,不是吗?</p>
<h4 id="目前最优雅的办法-lambda"><a href="#目前最优雅的办法-lambda" class="headerlink" title="目前最优雅的办法-lambda"></a>目前最优雅的办法-lambda</h4><p>查了N多资料后,我终于找到了一个优雅的办法, 那就是使用lambda表达式, 客户代码很简单, 而且类型安全</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//混合型Map</span></span><br><span class="line">Map&lt;String,Object&gt; map = hashMap(id -&gt; <span class="number">5</span>,name -&gt; <span class="string">"xuqi"</span>,age -&gt; <span class="number">18</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//String</span></span><br><span class="line">Map&lt;String,String&gt; stringMap = hashMap(id -&gt; <span class="string">"5"</span>,name -&gt; <span class="string">"xuqi"</span>,age -&gt; <span class="string">"18"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Integer</span></span><br><span class="line">Map&lt;String,Integer&gt; intMap = hashMap(id -&gt; <span class="number">5</span>,name -&gt; <span class="number">6666</span>,age -&gt; <span class="number">18</span>);</span><br></pre></td></tr></table></figure>
<p>实现方法至少需要Java 8u60, 而且在编译时需要加上 -parameters 参数, 在gradle可以加上下面的代码<br><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">	configure(<span class="keyword">options</span>) &#123;</span><br><span class="line">		<span class="keyword">options</span>.compilerArgs &lt;&lt; <span class="string">'-parameters'</span> &lt;&lt; <span class="string">'-Xlint:unchecked'</span> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个实现的关键是<code>SerializedLambda</code></p>
<p><a href="https://github.com/xuqifzz/Literals/blob/master/Literals.java" target="_blank" rel="noopener">实现代码</a></p>
<p>下面是代码中最主要的部分, 获取lambda表达式的参数名</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Method replaceMethod = getClass().getDeclaredMethod(<span class="string">"writeReplace"</span>);</span><br><span class="line">replaceMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">SerializedLambda lambda= (SerializedLambda) replaceMethod.invoke(<span class="keyword">this</span>);</span><br><span class="line">Class&lt;?&gt; containingClass = Class.forName(lambda.getImplClass().replaceAll(<span class="string">"/"</span>,<span class="string">"."</span>));</span><br><span class="line">Method method = asList(containingClass.getDeclaredMethods())</span><br><span class="line">        .stream()</span><br><span class="line">        .filter(method0 -&gt; Objects.equals(method0.getName(), lambda.getImplMethodName()))</span><br><span class="line">        .findFirst()</span><br><span class="line">        .orElseThrow(UnableToGuessMethodException::<span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">return</span> method.getParameters()[<span class="number">0</span>].getName();</span><br></pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="https://www.baeldung.com/java-initialize-hashmap" target="_blank" rel="noopener">https://www.baeldung.com/java-initialize-hashmap</a></li>
<li><a href="https://benjiweber.co.uk/blog/2015/08/17/lambda-parameter-names-with-reflection/" target="_blank" rel="noopener">https://benjiweber.co.uk/blog/2015/08/17/lambda-parameter-names-with-reflection/</a></li>
<li><a href="https://gist.github.com/galdosd/10823529" target="_blank" rel="noopener">https://gist.github.com/galdosd/10823529</a></li>
</ul>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#其他语言的做法"><span class="toc-number">1.</span> <span class="toc-text">其他语言的做法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java中的一些解决办法"><span class="toc-number">2.</span> <span class="toc-text">Java中的一些解决办法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#双括号初始化法"><span class="toc-number">2.1.</span> <span class="toc-text">双括号初始化法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二维数组封装法"><span class="toc-number">2.2.</span> <span class="toc-text">二维数组封装法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#参数列表封装法"><span class="toc-number">2.3.</span> <span class="toc-text">参数列表封装法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#目前最优雅的办法-lambda"><span class="toc-number">2.4.</span> <span class="toc-text">目前最优雅的办法-lambda</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2019 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
