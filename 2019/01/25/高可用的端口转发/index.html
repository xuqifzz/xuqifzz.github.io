<!DOCTYPE html>
<html lang=>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="专注于应用程序框架开发">
  <meta name="keywords" content="">
  
    <link rel="icon" href="/favicon.ico">
  
    
  <title>高可用的端口转发 | 徐琦的博客</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/lib/jquery.fancybox.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <header>
  <div class="header-container">
    <a class="logo" href="/">
      <span>徐琦的博客</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id="post">
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>高可用的端口转发</h1>
          <div class="post-meta">
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2019/01/25</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/网络运维/">网络运维</a>
  </div>



            
            
              | 
                  <i class="fa fa-tags" aria-hidden="true"></i>
                
               
  <a href="/tags/#网络运维" class="tag">网络运维</a>

  <a href="/tags/#C#" class="tag">C#</a>


            
          </div>
          <p>在windows下, 利用<code>netsh</code>可以实现端口转发功能, 能满足大部分日常需求, 但在某些情况下, 在后端节点不可用的时候, 需要将数据转发至另一节点, 这时就只能自行编码实现了。</p>
<p>本文将使用C#做一个简单的实现: <a href="https://github.com/xuqifzz/TcpForwording/blob/master/Proxy.cs" target="_blank" rel="noopener">完整代码</a></p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li>因为需要转发数据, 所以程序肯定是要监听端口的</li>
<li>为了避免数据混乱和复杂性, 这里每个端口只接收一个连接, 所以接收到新连接后, 关闭端口监听</li>
<li>若长时间没有数据通讯, 则主动关闭连接, 释放资源</li>
<li>开启两个工作线程,  一个叫代理线程, 一个叫转发线程</li>
</ul>
<h3 id="代理线程工作流程"><a href="#代理线程工作流程" class="headerlink" title="代理线程工作流程"></a>代理线程工作流程</h3><p>代理线程负责接收外来连接, 并确保同一时间只有一个外来连接, 接收到连接后读取数据, 读取到数据后, 将数据转发到指定目标地址。</p>
<p>主要代码:<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">server = <span class="keyword">new</span> TcpListener(listen);</span><br><span class="line">server.Start(<span class="number">1</span>);</span><br><span class="line">client = server.AcceptTcpClient();</span><br><span class="line">server.Stop();      <span class="comment">//停止监听, 同一时间只接收一个连接</span></span><br><span class="line">server = <span class="literal">null</span>;</span><br><span class="line">listenStream = client.GetStream();</span><br><span class="line">listenStream.ReadTimeout = READ_TIMEOUT;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> len = listenStream.Read(buffer, <span class="number">0</span>, BUFF_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] tmp = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">        Array.Copy(buffer, tmp, len);</span><br><span class="line">        Forwarding(tmp);  <span class="comment">//转发数据</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//.. 处理连接中断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="转发线程工作流程"><a href="#转发线程工作流程" class="headerlink" title="转发线程工作流程"></a>转发线程工作流程</h3><p>转发线程负责连接目标地址, 一个连不上再去连接下一个, 当连上后, 等待接收数据, 接收到数据后, 将数据转发到代理连接上去。</p>
<p>主要代码:<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">client = <span class="keyword">new</span> TcpClient();</span><br><span class="line"><span class="keyword">var</span> result = client.BeginConnect(currentEndPoint.Address, currentEndPoint.Port, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">var</span> success = result.AsyncWaitHandle.WaitOne(TimeSpan.FromMilliseconds(CONNECT_TIMEOUT));</span><br><span class="line"><span class="keyword">if</span> (!success)   <span class="comment">//超时处理</span></span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(<span class="string">"connect &#123;0&#125; timeout"</span>, currentEndPoint);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">client.EndConnect(result);</span><br><span class="line">forwardingStream = client.GetStream();</span><br><span class="line">forwardingStream.ReadTimeout = READ_TIMEOUT;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> len = forwardingStream.Read(buffer, <span class="number">0</span>, BUFF_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] tmp = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">        Array.Copy(buffer, tmp, len);</span><br><span class="line">        Response(tmp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//.. 处理连接中断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#解决思路"><span class="toc-number">1.</span> <span class="toc-text">解决思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代理线程工作流程"><span class="toc-number">2.</span> <span class="toc-text">代理线程工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转发线程工作流程"><span class="toc-number">3.</span> <span class="toc-text">转发线程工作流程</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2019 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="/lib/jquery.fancybox.min.js"></script>


</body>
</html>
